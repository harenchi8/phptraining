
# 第3週 実践課題

この課題では、エラー処理、セキュリティ対策、そしてそれらを組み込んだミニアプリケーションの作成を行います。

---

## 課題1: バリデーションとCSRF対策の実装 (9/6)

**目的:**
第2週で作成した簡易掲示板に、入力値の検証（バリデーション）とCSRF対策を追加し、より堅牢なアプリケーションにする方法を学びます。

**手順:**

1.  第2週で作成した `bbs.php` と `data.json` を `week3` ディレクトリにコピーします。

2.  `bbs.php` を修正し、以下のバリデーション機能を追加してください。
    *   「名前」と「メッセージ」の両方が入力されているかチェックします。どちらか一方でも空の場合は、エラーメッセージを表示し、`data.json` への書き込みは行いません。
    *   エラーメッセージはフォームの上部などに分かりやすく表示してください。
    *   （発展）名前は20文字以内、メッセージは100文字以内という文字数制限も追加してみましょう。

3.  次に、`bbs.php` にCSRF対策を実装してください。
    *   フォームが表示される際に、セッションを利用してCSRFトークンを生成し、`hidden`フィールドに埋め込みます。
    *   フォームがPOSTされた際に、送信されたトークンとセッションに保存したトークンが一致するかを検証します。
    *   トークンが一致しない、または存在しない場合は、「不正なリクエストです」といったエラーメッセージを表示して処理を中断します。

**動作確認:**

1.  名前やメッセージを空のまま投稿しようとすると、エラーメッセージが表示され、投稿が保存されないことを確認します。
2.  正常に投稿できることを確認します。
3.  （CSRF確認は難しいですが）コード上でトークンの比較が正しく行われているか、意図的にトークンを書き換えてみて（開発者ツールでhiddenの値を消すなど）、エラーになることを確認します。

---

## 課題2: ミニアプリ① お問い合わせフォーム制作 (9/7)

**目的:**
これまでの知識（フォーム処理、セッション、バリデーション、セキュリティ）を総動員して、実践的なお問い合わせフォームをゼロから作成します。

**構成ファイル:**
- `contact_form.php` (入力画面)
- `contact_confirm.php` (確認画面)
- `contact_complete.php` (完了画面)

**実装フロー:**

1.  **`contact_form.php` (入力画面)**
    *   セッションを開始します。
    *   CSRFトークンを生成し、セッションとフォームにセットします。
    *   フォームには「お名前」「メールアドレス」「お問い合わせ内容」の3つの入力欄を設けます。
    *   フォームの送信先は自分自身 (`contact_form.php`) とし、`method="POST"`にします。
    *   （エラーからのリダイレクト時）セッションにエラーメッセージや入力値があれば、それを表示・復元します。処理後にセッションから削除するのを忘れないように。

2.  **POSTリクエスト処理 (同じく `contact_form.php` 内)**
    *   POSTリクエストを受け取ったら、まずCSRFトークンを検証します。
    *   次に入力値をバリデーションします。
        *   **お名前**: 必須。
        *   **メールアドレス**: 必須、かつメールアドレスの形式として正しいか (`filter_var`)。
        *   **お問い合わせ内容**: 必須。
    *   **バリデーションエラーがあった場合**:
        *   エラーメッセージの配列を作成します。
        *   入力された値とエラーメッセージ配列をセッションに保存します。
        *   `contact_form.php` にリダイレクトします。
    *   **バリデーションを通過した場合**:
        *   入力された値をセッションに保存します。
        *   `contact_confirm.php` にリダイレクトします。

3.  **`contact_confirm.php` (確認画面)**
    *   セッションを開始します。
    *   セッションに保存された入力内容（名前、メール、内容）がなければ、`contact_form.php` にリダイレクトします（直接アクセス対策）。
    *   セッションから入力内容を取得し、画面に表示します。
    *   「送信する」ボタンと「戻る」リンクを設置します。
    *   「戻る」リンクは `contact_form.php` に戻るようにします。
    *   「送信する」ボタンは `contact_complete.php` にPOSTするフォームとします。この時、CSRF対策も再度行いましょう（確認画面でトークンを再生成）。

4.  **`contact_complete.php` (完了画面)**
    *   セッションを開始します。
    *   CSRFトークンを検証します。
    *   セッションに入力内容がなければ `contact_form.php` にリダイレクトします。
    *   「お問い合わせありがとうございました。」というメッセージを表示します。
    *   **疑似メール送信処理**: 本来はここで `mb_send_mail` などを使いますが、今回は「以下の内容で管理者宛にメールを送信しました。」というメッセージと共に、セッションから取得した内容（名前、メール、問い合わせ内容）を画面に表示するだけでOKです。
    *   最後に、利用したセッション情報をすべてクリアします。

**動作確認:**
- 各バリデーションが正しく機能すること。
- エラー時に、入力した値が消えずにフォームに復元されること。
- 確認画面、完了画面へと正しく遷移すること。
- 確認画面や完了画面に直接URLでアクセスしようとすると、入力画面に弾かれること。
