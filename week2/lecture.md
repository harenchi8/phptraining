# 第2週 座学テキスト

## 1. セッションとCookie管理 (8/30)

### なぜ状態管理が必要か？ (HTTPのステートレス性)

HTTPプロトコルは「ステートレス」です。つまり、サーバーはクライアントからの各リクエストを完全に独立したものとして扱い、過去のリクエストを記憶しません。しかし、Webアプリケーションでは「ログインしている状態」「ショッピングカートの中身」など、複数のページにまたがって情報を維持する必要があります。このためにCookieとセッションという技術が使われます。

---

### Cookieとは

- **概要**: サーバーからの指示で、**ユーザーのブラウザ（クライアント側）に保存される**小さなテキストデータです。
- **仕組み**:
    1.  サーバーがレスポンスヘッダーに「この情報を保存してください」という`Set-Cookie`ヘッダーを含めて送信します。
    2.  ブラウザはその情報を受け取り、PC内に保存します。
    3.  次回以降、同じサーバーにリクエストを送る際、ブラウザは自動的に保存しておいたCookieをリクエストヘッダーに含めて送信します。
- **利点**: ユーザーのPCに保存されるため、ブラウザを閉じてもデータを保持できます（有効期限の設定による）。
- **欠点**: クライアント側で簡単に改ざんできるため、パスワードのような重要な情報を直接保存してはいけません。

---

### セッションとは

- **概要**: **サーバー側でデータを保存し**、ユーザーを識別するための仕組みです。
- **仕組み**:
    1.  ユーザーが初めてサイトにアクセスすると、PHPはユニークな「セッションID」を生成します。
    2.  PHPは、このセッションIDをCookieを使ってユーザーのブラウザに保存させます。
    3.  サーバー側では、セッションIDと関連付けて、そのユーザーのデータ（例: ユーザー名、カートの中身）を特別なファイルやDBに保存します。
    4.  次回以降のアクセスでは、ブラウザがCookie経由でセッションIDを送信するため、サーバーは「どのユーザーからのリクエストか」を特定し、対応するデータを読み出すことができます。
- **利点**: データはサーバー側にあるため、ユーザーによる改ざんが困難で安全です。
- **欠点**: サーバーのリソースを消費します。多くのユーザーがアクセスすると負荷が上がることがあります。

### PHPでのセッションの使い方

セッションを利用するには、**必ずスクリプトの最初に `session_start()` を呼び出す**必要があります。

```php
<?php
// 1. セッションを開始（または再開）
session_start();

// 2. セッションにデータを保存
$_SESSION["user_name"] = '山田';
$_SESSION['visit_count'] = 1;

// 3. セッションからデータを取得
echo 'ようこそ、' . $_SESSION['user_name'] . 'さん';

// 4. セッションデータを変更
$_SESSION['visit_count']++;
echo 'あなたの訪問回数は' . $_SESSION['visit_count'] . '回目です。';

// 5. 特定のセッション変数を削除
unset($_SESSION['user_name']);

// 6. セッションを完全に破棄（ログアウトなどで使用）
// セッション変数をすべて空にする
$_SESSION = [];

// Cookieに保存されているセッションIDも削除
if (isset($_COOKIE[session_name()])) {
    setcookie(session_name(), '', time() - 42000, '/');
}

// サーバー上のセッションファイルを削除
session_destroy();

?>
```

---

## 2. ファイル操作・JSON入門 (8/31)

### PHPによるファイル操作

PHPでは、サーバー上のファイルを読み書きする関数が用意されています。

- **`file_get_contents("ファイルパス")`**: ファイルの内容をすべて読み込み、文字列として返します。シンプルでよく使われます。
- **`file_put_contents("ファイルパス", "書き込む内容", [オプション])`**: ファイルにデータを書き込みます。
    - `FILE_APPEND` オプションを指定すると、ファイル末尾に追記します。指定しない場合は上書きされます。

```php
<?php
$file = 'data.txt';

// ファイルへの書き込み（上書き）
file_put_contents($file, "Hello, PHP!\n");

// ファイルへの追記
file_put_contents($file, "Welcome to file handling.\n", FILE_APPEND);

// ファイルの読み込み
$content = file_get_contents($file);
echo nl2br($content); // nl2brは改行\nを<br>タグに変換する関数

?>
```

### JSONとは

JSON (JavaScript Object Notation) は、軽量なデータ交換フォーマットです。JavaScriptのオブジェクトリテラルをベースにしていますが、PHPを含む多くの言語で簡単に利用できます。

- **特徴**: 人間にも機械にも読み書きしやすい。キーと値のペアで構成される。
- **用途**: Web APIでのデータ送受信、設定ファイルの記述など。

**JSONの例:**
```json
{
  "name": "山田太郎",
  "age": 30,
  "skills": ["PHP", "JavaScript", "MySQL"]
}
```

### PHPでのJSONの扱い方

- **`json_encode()`**: PHPの**配列（特に連想配列）をJSON形式の文字列に変換**します。
- **`json_decode()`**: **JSON形式の文字列をPHPのデータ型（デフォルトではオブジェクト、第二引数に`true`を指定すると連想配列）に変換**します。

```php
<?php
// PHPの連想配列
$user = [
    'id' => 1,
    'name' => '鈴木一郎',
    'email' => 'suzuki@example.com'
];

// 配列をJSON文字列に変換
$json_string = json_encode($user, JSON_UNESCAPED_UNICODE);
echo $json_string; // -> {"id":1,"name":"鈴木一郎","email":"suzuki@example.com"}

// JSON文字列をPHPの連想配列に変換
$decoded_array = json_decode($json_string, true);
print_r($decoded_array);

echo $decoded_array['name']; // -> 鈴木一郎

?>
```
> `JSON_UNESCAPED_UNICODE` は、日本語などを `\uXXXX` のようにエスケープせず、そのままUTF-8で出力するためのオプションです。

```